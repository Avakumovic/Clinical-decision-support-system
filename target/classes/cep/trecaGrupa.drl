package ljubisa

import ljubisa.model.*;
import java.util.Set
import java.util.List
import java.time.LocalDate
global Bolest prehlada;
global Bolest groznica;
global Bolest upalaKrajnika;
global Bolest sinusnaInfekcija;
global Bolest hronicnaBubreznaBolest;
global Bolest akutnaBubreznaBolest;
global Bolest hipertenzija;
global Bolest dijabetes;

rule "bolovanje od hipertenzije vishe od 6 meseci"
agenda-group "treca"
salience 330
	when
		$pr:Pregled($pac:pacijent)
		$pacient:Pacijent(this==$pac, $ter:terapije) from $pac
		$l:List(size>0) from collect ($pt:Terapija(bolest.naziv=="hipertenzija",
		$pt.getDatum().isBefore(LocalDate.now().minusMonths(6)))from $ter) 
 	then
		$pr.getSpecificniSimptomi().add(SpecificniSimptomi.BOLUJE_OD_HIPERTENZIJE_DUZE_OD_6_MESECI);
end

rule "boluje od dijabetesa"
agenda-group "treca"
salience 330
	when
		$pr:Pregled($pac:pacijent )
		$pacijent:Pacijent(this==$pac, $ter:terapije) from $pac
		$l:List(size>0) from collect ($pt:Terapija((bolest.naziv =="dijabetes" ))from $ter) 
 	then
		$pr.getSpecificniSimptomi().add(SpecificniSimptomi.BOLUJE_OD_DIJABETESA);
end

rule "poslednjih 14 dana dijagnostikovana boles koja kao simptom ima povecanu telestnu temperaturu"
agenda-group "treca"
salience 330
	when
		$pr:Pregled($pac:pacijent)
		$pacijent:Pacijent(this==$pac, $ter:terapije) from $pac
		$l: List (size >0 ) from collect ($pt:Terapija((uZadnjih14Dana() &&
		((bolest.sviSimptomi contains (SviSimptomi.TEMPERATURA_IZMEDJU_40_I_41)) ||
		(bolest.sviSimptomi contains (SviSimptomi.TEMPERATURA_VECA_OD_38)))))from $ter) 
 	then
		$pr.getSpecificniSimptomi().add(SpecificniSimptomi.POVISENA_TEMPERATURA_U_POSLEDNJIH_14_DANA);
end

rule "poslednjih 21 primao antibiotike"
agenda-group "treca"
salience 330
	when
		$pr:Pregled($pac:pacijent)
		$pacijent:Pacijent(this==$pac, $ter:terapije) from $pac
		$pt:Terapija($lekovi:lekovi, uZadnjih21Dana())from $ter
		$l:List(size>0) from collect (Lek(jeProbiotic()) from $prepisaniLekovi) 
 	then
		$pr.getSpecificniSimptomi().add(SpecificniSimptomi.PREPISANI_ANTIBIOTICI_U_POSLEDNIH_21_DAN);	
end


rule "hronicnaBubreznaBolest moze biti"
agenda-group "treca"
salience 300
    when
        $pr:Pregled($sim:sviSimptomi, $mogucaB:potencijalneBolesti, $specSimpt:specificniSimptomi)  and
		$sss:Set() from collect($s:SviSimptomi(
			this==SviSimptomi.UMOR ||
			this==SviSimptomi.NOCTURIA ||
			this==SviSimptomi.OTOCI_NOGU_I_ZGLOBOVA ||
			this==SviSimptomi.GUSENJE ||
			this==SviSimptomi.BOL_U_GRUDIMA
		)from $sim) and
		eval($sss.size()>1)
		$sSpec:Set() from collect ($spSim:SpecificniSimptomi( 
		 	this==SpecificniSimptomi.BOLUJE_OD_DIJABETESA ||
		 	this==SpecificniSimptomi.BOLUJE_OD_HIPERTENZIJE_DUZE_OD_6_MESECI)
		from $specSimpt) and
		eval($sSpec.size()>=1) and
		$dajMiBolest:PotencijalnaBolest(nazivBolesti=="hronicnaBubreznaBolest") from $mogucaB
    then
        $dajMiBolest.setSansa(($sss.size()+2*$sSpec.size())/9.0);
end

rule "akutnaBubreznaBolest moze biti"
agenda-group "treca"
salience 300
    when
	    $pr:Pregled($sim:sviSimptomi, $mogucaB:potencijalneBolesti, $specSimpt:specificniSimptomi)  and
		$sss:Set() from collect($s:SviSimptomi(
			this==SviSimptomi.UMOR ||
			this==SviSimptomi.GUSENJE ||
			this==SviSimptomi.OTOCI_NOGU_I_ZGLOBOVA ||
			this==SviSimptomi.DIJAREJA
		 ) from $sim) and
		eval($sss.size()>1)
		$sSpec:Set() from collect ($spSim : SpecificniSimptomi( 
		 	this== SpecificniSimptomi.OPORAVLJA_SE_OD_OPERACIJE ||
		 	this== SpecificniSimptomi.POVISENA_TEMPERATURA_U_POSLEDNJIH_14_DANA ||
		 	this== SpecificniSimptomi.PREPISANI_ANTIBIOTICI_U_POSLEDNIH_21_DAN  
		  )
		from $specSimpt) and
		eval($sSpec.size() >=1) and
		$dajMiBolest : PotencijalnaBolest(nazivBolesti=="akutnaBubreznaBolest") from $mogucaB
		 
    then
        $dajMiBolest.setSansa(($sss.size()+2*$sSpec.size())/10.0);
end

rule "nadji najbolu mogucnost za trecu grupu"
agenda-group "treca"
salience 200
	when
		$pr:Pregled($mog:potencijalneBolesti)
		$n:Double(doubleValue>=0.0) from accumulate(
		$mb:PotencijalnaBolest($mm:sansa) from $mog,max($mm))
	then
		$pr.setNajboljaProcena($n);
end

rule "da li je hronicnaBubreznaBolest"
agenda-group "treca"
salience 109
enabled false
	when
		$pr:Pregled($mog:potencijalneBolesti, $pro:najboljaProcena)
		$l:List(size >0) from collect($m:PotencijalnaBolest(sansa==$pro && nazivBolesti==hronicnaBubreznaBolest.getNaziv()) from $mog)
	then
		Terapija t = new Terapija(hronicnaBubreznaBolest,null,null,null);
		$pr.getPacijent().getTerapije().add(t);
		int temp = $pr.getPacijent().getTerapije().size();
end

rule "da li je akutnaBubreznaBolest"
agenda-group "treca"
enabled false
salience 110
	when
		$pr:Pregled($mog: potencijalneBolesti, $pro:najboljaProcena)
		$l:List(size >0) from collect($m:PotencijalnaBolest(sansa==$pro && nazivBolesti==akutnaBubreznaBolest.getNaziv()) from $mog)
	then
		Terapija t = new Terapija(akutnaBubreznaBolest,null,null,null);
		$pr.getPacijent().getTerapije().add(t);
		int temp = $pr.getPacijent().getTerapije().size();
end

rule "print specificni simptomi"
agenda-group "treca"
salience -10
enabled true
	when 
		$pr:Pregled()
	then
		//System.out.println($p.getSpecificniSimptomi());
end